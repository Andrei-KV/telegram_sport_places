<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –ø–ª–æ—â–∞–¥–∫–∏ ‚Äî MiniApp</title>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Leaflet (–∫–∞—Ä—Ç—ã) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  :root{
    --bg: var(--tg-theme-bg-color,#ffffff);
    --text: var(--tg-theme-text-color,#000000);
    --hint: var(--tg-theme-hint-color,#666666);
    --card-light-bg: rgba(0,0,0,0.05);
    --card-dark-bg: rgba(255,255,255,0.06);
    --accent: var(--tg-theme-button-color,#1976d2);
  }

  html,body{height:100%; margin:0; padding:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}

  header { padding:10px 12px; text-align:center; position:sticky; top:0; background:transparent; z-index:10; }
  h1 { margin:6px 0; font-size:18px; }
  .grid { display:grid; gap:10px; padding:10px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
  .card {
    border-radius:12px;
    padding:8px;
    cursor:pointer;
    user-select:none;
    transition:transform .12s;
    color:var(--text);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:110px;
    text-align:center;
    box-shadow: 0 1px 0 rgba(0,0,0,0.03);
  }
  .card:active{ transform: translateY(1px); }

  /* —Å–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
  body.light .card { background: var(--card-light-bg); }
  body.dark  .card { background: var(--card-dark-bg); }

  .card img.thumb { width:100%; height:110px; object-fit:cover; border-radius:8px; margin-bottom:8px; }

  .category-label { font-weight:600; margin-top:6px; font-size:15px; color:var(--text); }

  .back-btn {
    margin: 8px 12px;
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: var(--accent);
    color: #fff;
    font-weight:600;
  }

  #map { height:300px; margin:10px; border-radius:12px; overflow:hidden; }

  .place-row { display:flex; gap:10px; align-items:center; cursor:pointer; padding:8px; border-radius:10px; }
  .place-row:hover { filter:brightness(0.98); }
  .place-row img { width:96px; height:72px; object-fit:cover; border-radius:8px; }

  .photo-strip { display:flex; gap:8px; padding:10px; overflow-x:auto; }
  .photo-strip img { height:110px; border-radius:10px; cursor:pointer; object-fit:cover; }

  /* fullscreen overlay */
  .fullscreen-overlay {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.9); z-index:9999;
  }
  .fullscreen-overlay img { max-width:94%; max-height:94%; border-radius:8px; }

  .muted { color:var(--hint); font-size:14px; text-align:center; padding:8px; }
</style>
</head>
<body>
  <div id="app"><h1 style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞...</h1></div>

<script>
/* ============== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ============== */
const API_BASE = "https://sport-places-472310.ew.r.appspot.com/api/v1";
const app = document.getElementById('app');
const tg = window.Telegram?.WebApp || {}; try{ tg.expand(); }catch(e){}
document.addEventListener('DOMContentLoaded', ()=>{/*noop*/});

/* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–≤–µ—Ç–ª–æ–π/—Ç—ë–º–Ω–æ–π —Ç–µ–º—ã (—á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –±—ã–ª–∏ —á–∏—Ç–∞–µ–º—ã) */
try {
  const scheme = (tg.colorScheme || 'light'); // 'dark' –∏–ª–∏ 'light'
  document.body.classList.add(scheme);
} catch(e){ document.body.classList.add('light'); }

/* –ù–µ–±–æ–ª—å—à–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–∫–æ–Ω–æ–∫ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å) */
const ICONS = {
  "—Ñ—É—Ç–±–æ–ª":"‚öΩ","–±–∞—Å–∫–µ—Ç–±–æ–ª":"üèÄ","–≤–æ–ª–µ–π–±–æ–ª":"üèê","–±–∞–¥–º–∏–Ω—Ç–æ–Ω":"üè∏","–∫–∞—Ç–æ–∫":"‚õ∏",
  "—Ç–µ–Ω–Ω–∏—Å":"üéæ","–ª—ã–∂–∏":"üéø","—Å–Ω–æ—É–±–æ—Ä–¥":"üèÇ","–≤–æ—Ä–∫–∞—É—Ç":"üí™","—ç–∫—Å—Ç—Ä–∏–º":"ü§∏","default":"üèüÔ∏è"
};

/* escape to avoid XSS when inserting names in innerHTML */
function escapeHtml(s){
  if(!s && s!==0) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]; });
}

/* –∫–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ (action - JS-–≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä "loadCategories()") */
function backButton(action){
  return `<div style="padding:0 10px 6px 10px"><button class="back-btn" onclick="${action}">‚¨Ö –ù–∞–∑–∞–¥</button></div>`;
}

/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É */
function showError(text){
  app.innerHTML = `<div style="padding:16px"><h2 style="text-align:center">–û—à–∏–±–∫–∞</h2><p class="muted">${escapeHtml(text)}</p></div>`;
  console.error(text);
}

/* ============== –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ============== */
async function loadCategories(){
  app.innerHTML = `<h1 style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π‚Ä¶</h1>`;
  try{
    const r = await fetch(`${API_BASE}/categories/`);
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const categories = await r.json();
    categories.sort((a,b)=>a.name.localeCompare(b.name,'ru')); // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É

    let html = `<header><h1>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h1></header>`;
    html += `<div class="grid">`;
    for(const c of categories){
      // –ø–æ–¥–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É –ø–æ –∏–º–µ–Ω–∏ (–ø—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –≤ –∫–ª—é—á–∞—Ö ICONS)
      const low = (c.name || '').toLowerCase();
      let icon = ICONS['default'];
      for(const k of Object.keys(ICONS)){
        if(k==='default') continue;
        if(low.includes(k)) { icon = ICONS[k]; break; }
      }
      html += `<div class="card" onclick="loadPlaces('${escapeHtml(c.slug)}','${escapeHtml(c.name)}')">
                 <div style="font-size:32px">${icon}</div>
                 <div class="category-label">${escapeHtml(c.name)}</div>
                 <div style="font-size:13px;color:var(--hint)">${c.place_count ?? 0} –ø–ª–æ—â–∞–¥–æ–∫</div>
               </div>`;
    }
    html += `</div>`;
    app.innerHTML = html;
  } catch(err){
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ' + err.message);
  }
}

/* ============== –°–ø–∏—Å–æ–∫ –ø–ª–æ—â–∞–¥–æ–∫ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ============== */
async function loadPlaces(categorySlug, categoryName){
  currentCategory = {slug: categorySlug, name: categoryName};
  app.innerHTML = `<h1 style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–æ—â–∞–¥–æ–∫‚Ä¶</h1>`;
  try{
    const r = await fetch(`${API_BASE}/categories/${encodeURIComponent(categorySlug)}/places/`);
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const places = await r.json();

    let html = `<header><h1>${escapeHtml(categoryName)}</h1></header>`;
    html += backButton('loadCategories()');

    if(!places.length){
      html += `<p class="muted">–ü–ª–æ—â–∞–¥–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>`;
      app.innerHTML = html;
      return;
    }

    // —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫
    html += `<div style="padding:8px">`;
    for(const p of places){
      const thumb = p.first_photo || '';
      html += `<div class="place-row card" onclick="loadPlace(${Number(p.id)})">
                 ${thumb ? `<img src="${escapeHtml(thumb)}" alt="${escapeHtml(p.name)}">`
                        : `<div style="width:96px;height:72px;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center">üìç</div>`}
                 <div style="flex:1">
                   <div style="font-weight:600">${escapeHtml(p.name)}</div>
                 </div>
               </div>`;
    }
    html += `</div>`;
    // –∫–∞—Ä—Ç–∞
    html += `<div id="map"></div>`;
    app.innerHTML = html;

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Leaflet
    setTimeout(()=>{
      try {
        if(window._currentMap) { window._currentMap.remove(); window._currentMap = null; }
        const lat = parseFloat(places[0].latitude), lon = parseFloat(places[0].longitude);
        const map = window._currentMap = L.map('map', {zoomControl:true, attributionControl:true}).setView([lat, lon], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '¬© OpenStreetMap' }).addTo(map);

        for(const p of places){
          const plat = parseFloat(p.latitude), plon = parseFloat(p.longitude);
          if(Number.isNaN(plat) || Number.isNaN(plon)) continue;
          const routeUrl = `https://yandex.ru/maps/?rtext=~${plat},${plon}&z=15`;
          L.marker([plat,plon]).addTo(map)
            .bindPopup(`<b>${escapeHtml(p.name)}</b><br><a href="${routeUrl}" target="_blank" rel="noreferrer">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</a>`);
        }
      } catch(e){ console.error(e); }
    }, 80);

  } catch(err){
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–æ—â–∞–¥–∫–∏: ' + err.message);
  }
}

/* ============== –î–µ—Ç–∞–ª–∏ –ø–ª–æ—â–∞–¥–∫–∏ ============== */
async function loadPlace(id){
  app.innerHTML = `<h1 style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Å—Ç–∞‚Ä¶</h1>`;
  try{
    const r = await fetch(`${API_BASE}/places/${Number(id)}/`);
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const p = await r.json();

    let html = `<header><h1>${escapeHtml(p.name)}</h1></header>`;
    html += backButton(`loadPlaces('${escapeHtml(currentCategory.slug)}','${escapeHtml(currentCategory.name)}')`);

    if(p.description) html += `<div style="padding:0 12px 8px 12px"><p style="margin:0">${escapeHtml(p.description)}</p></div>`;

    // —Ñ–æ—Ç–æ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ photos –∏–∑ PlaceDetailSerializer)
    if(Array.isArray(p.photos) && p.photos.length){
      html += `<div class="photo-strip">`;
      for(const ph of p.photos){
        html += `<img src="${escapeHtml(ph)}" onclick="showFullscreen('${encodeURIComponent(ph)}')" />`;
      }
      html += `</div>`;
    } else if (p.first_photo) {
      html += `<div style="padding:10px"><img src="${escapeHtml(p.first_photo)}" style="width:100%;border-radius:10px"></div>`;
    }

    html += `<div id="map"></div>`;
    app.innerHTML = html;

    // –∫–∞—Ä—Ç–∞ —Å –æ–¥–Ω–∏–º –º–∞—Ä–∫–µ—Ä–æ–º
    setTimeout(()=>{
      try {
        if(window._currentMap) { window._currentMap.remove(); window._currentMap = null; }
        const lat = parseFloat(p.latitude), lon = parseFloat(p.longitude);
        const map = window._currentMap = L.map('map', {zoomControl:true, attributionControl:true}).setView([lat, lon], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '¬© OpenStreetMap' }).addTo(map);
        const routeUrl = `https://yandex.ru/maps/?rtext=~${lat},${lon}&z=15`;
        L.marker([lat, lon]).addTo(map).bindPopup(`<b>${escapeHtml(p.name)}</b><br><a href="${routeUrl}" target="_blank" rel="noreferrer">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</a>`).openPopup();
      } catch(e){ console.error(e); }
    }, 80);

  } catch(err){
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞: ' + err.message);
  }
}

/* –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä */
function showFullscreen(encodedSrc){
  const src = decodeURIComponent(encodedSrc);
  const overlay = document.createElement('div');
  overlay.className = 'fullscreen-overlay';
  overlay.innerHTML = `<img src="${escapeHtml(src)}" alt="–§–æ—Ç–æ" />`;
  overlay.addEventListener('click', ()=>document.body.removeChild(overlay));
  document.body.appendChild(overlay);
}

/* —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ */
let currentCategory = null;
loadCategories();
</script>
</body>
</html>
