<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –ø–ª–æ—â–∞–¥–∫–∏</title>

<!-- Telegram SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body {
    margin: 0; padding: 0;
    background: var(--tg-theme-bg-color, #fff);
    color: var(--tg-theme-text-color, #000);
    font-family: sans-serif;
  }
  h1,h2 { text-align: center; }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
    gap: 10px;
    padding: 10px;
  }
  .card {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 8px;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
    color: var(--tg-theme-text-color, #000);
  }
  .card:hover { background: rgba(0,0,0,0.1); }
  .back-btn {
    margin: 10px;
    padding: 8px 12px;
    border: none;
    background: #1976d2;
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
  }
  #map { height: 300px; margin: 10px; border-radius: 12px; }
  img.place-photo { max-width: 95%; display:block; margin: 10px auto; border-radius:12px; }

  /* –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ —Ñ–æ—Ç–æ */
  .photo-strip {
    display: flex;
    overflow-x: auto;
    gap: 8px;
    padding: 10px;
  }
  .photo-strip img {
    height: 120px;
    border-radius: 10px;
    cursor: pointer;
  }

  /* –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä */
  .fullscreen-overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .fullscreen-overlay img {
    max-width: 90%;
    max-height: 90%;
  }
</style>
</head>
<body>

<div id="app"><h1>–ó–∞–≥—Ä—É–∑–∫–∞...</h1></div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_BASE = "https://sport-places-472310.ew.r.appspot.com/api/v1";
const app = document.getElementById('app');
let currentCategory = null;
let currentMap = null;

// –ò–∫–æ–Ω–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ø—Ä–∏–º–µ—Ä)
const ICONS = {
  "—Ñ—É—Ç–±–æ–ª":"‚öΩ","–±–∞—Å–∫–µ—Ç–±–æ–ª":"üèÄ","–≤–æ–ª–µ–π–±–æ–ª":"üèê","–±–∞–¥–º–∏–Ω—Ç–æ–Ω":"üè∏","–∫–∞—Ç–æ–∫":"‚õ∏",
  "—Ç–µ–Ω–Ω–∏—Å":"üéæ","–ª—ã–∂–∏":"üéø","—Å–Ω–æ—É–±–æ—Ä–¥":"üèÇ","–≤–æ—Ä–∫–∞—É—Ç":"üí™","—ç–∫—Å—Ç—Ä–∏–º":"ü§∏"
};

function showLoading(text="–ó–∞–≥—Ä—É–∑–∫–∞...") {
  app.innerHTML = `<h1>${text}</h1>`;
}

function backButton(cb) {
  return `<button class="back-btn" onclick="(${cb})()">‚¨Ö –ù–∞–∑–∞–¥</button>`;
}

// ---------- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ----------
async function loadCategories() {
  showLoading();
  const res = await fetch(`${API_BASE}/categories/`);
  const data = await res.json();
  data.sort((a,b)=>a.name.localeCompare(b.name,'ru'));
  let html = `<h1>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h1><div class="grid">`;
  data.forEach(c=>{
    const icon = Object.entries(ICONS).find(([k])=>c.name.toLowerCase().includes(k))?.[1] || "üèüÔ∏è";
    html += `<div class="card" onclick="loadPlaces('${c.slug}','${c.name}')">${icon}<br>${c.name}</div>`;
  });
  html += "</div>";
  app.innerHTML = html;
}

// ---------- –°–ø–∏—Å–æ–∫ –ø–ª–æ—â–∞–¥–æ–∫ ----------
async function loadPlaces(slug,name) {
  currentCategory = {slug,name};
  showLoading();
  const res = await fetch(`${API_BASE}/categories/${slug}/places/`);
  const places = await res.json();

  let html = `<h2>${name}</h2>${backButton('loadCategories')}`;
  if (!places.length) {
    html += `<p style="text-align:center">–ü–ª–æ—â–∞–¥–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>`;
    app.innerHTML = html;
    return;
  }

  html += `<div class="grid">`;
  for (const p of places) {
    // –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ
    let firstPhoto = "";
    try {
      const r = await fetch(`${API_BASE}/places/${p.id}/`);
      const d = await r.json();
      firstPhoto = d.first_photo || "";
    } catch {}
    html += `<div class="card" onclick="loadPlace(${p.id})">
      ${firstPhoto ? `<img src="${firstPhoto}" style="width:100%;border-radius:8px;margin-bottom:6px">` : ""}
      üìç ${p.name}
    </div>`;
  }
  html += `</div><div id="map"></div>`;
  app.innerHTML = html;

  // –∫–∞—Ä—Ç–∞ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏
  setTimeout(()=>{
    if (currentMap) currentMap.remove();
    currentMap = L.map('map').setView([places[0].latitude, places[0].longitude], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(currentMap);
    places.forEach(p=>{
      const routeUrl = `https://yandex.ru/maps/?rtext=~${p.latitude},${p.longitude}&z=15`;
      L.marker([p.latitude,p.longitude]).addTo(currentMap)
        .bindPopup(`<b>${p.name}</b><br><a href="${routeUrl}" target="_blank">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</a>`);
    });
  },50);
}

// ---------- –î–µ—Ç–∞–ª–∏ –ø–ª–æ—â–∞–¥–∫–∏ ----------
async function loadPlace(id) {
  showLoading();
  const res = await fetch(`${API_BASE}/places/${id}/`);
  const p = await res.json();

  let html = `<h2>${p.name}</h2>${backButton('()=>loadPlaces(currentCategory.slug,currentCategory.name)')}`;
  if (p.description) html += `<p style="text-align:center">${p.description}</p>`;

  // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ —Ñ–æ—Ç–æ
  if (p.photos && p.photos.length) {
    html += `<div class="photo-strip">`;
    p.photos.forEach(ph=>{
      html += `<img src="${ph}" onclick="showFullscreen('${ph}')">`;
    });
    html += `</div>`;
  } else if (p.first_photo) {
    html += `<img class="place-photo" src="${p.first_photo}">`;
  }

  html += `<div id="map"></div>`;
  app.innerHTML = html;

  setTimeout(()=>{
    if (currentMap) currentMap.remove();
    currentMap = L.map('map').setView([p.latitude, p.longitude], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(currentMap);
    const routeUrl = `https://yandex.ru/maps/?rtext=~${p.latitude},${p.longitude}&z=15`;
    L.marker([p.latitude,p.longitude]).addTo(currentMap)
      .bindPopup(`<b>${p.name}</b><br><a href="${routeUrl}" target="_blank">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</a>`).openPopup();
  },50);
}

// ---------- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ ----------
function showFullscreen(src){
  const overlay = document.createElement('div');
  overlay.className = 'fullscreen-overlay';
  overlay.innerHTML = `<img src="${src}" onclick="document.body.removeChild(this.parentNode)">`;
  document.body.appendChild(overlay);
}

// —Å—Ç–∞—Ä—Ç
loadCategories();
</script>
</body>
</html>
