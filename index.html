<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –ø–ª–æ—â–∞–¥–∫–∏</title>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body {
    margin: 0; padding: 0;
    background: var(--tg-theme-bg-color, #fff);
    color: var(--tg-theme-text-color, #000);
    font-family: sans-serif;
  }
  h1,h2 { text-align: center; }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(120px,1fr));
    gap: 10px;
    padding: 10px;
  }
  .card {
    background: #f0f0f0;
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
  }
  .card:hover { background: #e0e0e0; }
  .back-btn {
    margin: 10px;
    padding: 8px 12px;
    border: none;
    background: #1976d2;
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
  }
  #map { height: 300px; margin: 10px; border-radius: 12px; }
  img.place-photo { max-width: 95%; display:block; margin: 10px auto; border-radius:12px; }
</style>
</head>
<body>

<div id="app">
  <h1>–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_BASE = "https://sport-places-472310.ew.r.appspot.com/api/v1";
const app = document.getElementById('app');
let currentCategory = null;
let currentMap = null;

// --- –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏/emoji) ---
const ICONS = {
  "—Ñ—É—Ç–±–æ–ª":"‚öΩ","–±–∞—Å–∫–µ—Ç–±–æ–ª":"üèÄ","–≤–æ–ª–µ–π–±–æ–ª":"üèê","–±–∞–¥–º–∏–Ω—Ç–æ–Ω":"üè∏","–∫–∞—Ç–æ–∫":"‚õ∏",
  "—Ç–µ–Ω–Ω–∏—Å":"üéæ","–ª—ã–∂–∏":"üéø","—Å–Ω–æ—É–±–æ—Ä–¥":"üèÇ","–≤–æ—Ä–∫–∞—É—Ç":"üí™","—ç–∫—Å—Ç—Ä–∏–º":"ü§∏"
};

// ---------- UI ----------
function showLoading(text="–ó–∞–≥—Ä—É–∑–∫–∞...") {
  app.innerHTML = `<h1>${text}</h1>`;
}

function backButton(cb) {
  return `<button class="back-btn" onclick="(${cb})()">‚¨Ö –ù–∞–∑–∞–¥</button>`;
}

// ---------- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ----------
async function loadCategories() {
  showLoading();
  const res = await fetch(`${API_BASE}/categories/`);
  const data = await res.json();
  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏
  data.sort((a,b)=>a.name.localeCompare(b.name,'ru'));
  let html = `<h1>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h1><div class="grid">`;
  data.forEach(c=>{
    const icon = Object.entries(ICONS).find(([k])=>c.name.toLowerCase().includes(k))?.[1] || "üèüÔ∏è";
    html += `<div class="card" onclick="loadPlaces('${c.slug}','${c.name}')">${icon}<br>${c.name}</div>`;
  });
  html += "</div>";
  app.innerHTML = html;
}

// ---------- –°–ø–∏—Å–æ–∫ –ø–ª–æ—â–∞–¥–æ–∫ + –∫–∞—Ä—Ç–∞ ----------
async function loadPlaces(slug,name) {
  currentCategory = {slug,name};
  showLoading();
  const res = await fetch(`${API_BASE}/categories/${slug}/places/`);
  const places = await res.json();

  let html = `<h2>${name}</h2>${backButton('loadCategories')}`;
  if (places.length === 0) {
    html += `<p style="text-align:center">–ü–ª–æ—â–∞–¥–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>`;
    app.innerHTML = html;
    return;
  }

  html += `<div class="grid">`;
  places.forEach(p=>{
    html += `<div class="card" onclick="loadPlace(${p.id})">üìç<br>${p.name}</div>`;
  });
  html += `</div><div id="map"></div>`;
  app.innerHTML = html;

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã —Å –º–µ—Ç–∫–∞–º–∏
  setTimeout(()=>{
    if (currentMap) currentMap.remove();
    currentMap = L.map('map').setView([places[0].latitude, places[0].longitude], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(currentMap);
    places.forEach(p=>{
      L.marker([p.latitude,p.longitude]).addTo(currentMap)
        .bindPopup(p.name);
    });
  },50);
}

// ---------- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–ª–æ—â–∞–¥–∫–∏ ----------
async function loadPlace(id) {
  showLoading();
  const res = await fetch(`${API_BASE}/places/${id}/`);
  const p = await res.json();
  let html = `<h2>${p.name}</h2>${backButton('()=>loadPlaces(currentCategory.slug,currentCategory.name)')}`;
  html += `<p style="text-align:center">${p.description || ''}</p>`;
  if (p.first_photo) html += `<img class="place-photo" src="${p.first_photo}" alt="${p.name}">`;
  html += `<div id="map"></div>`;
  app.innerHTML = html;

  setTimeout(()=>{
    if (currentMap) currentMap.remove();
    currentMap = L.map('map').setView([p.latitude, p.longitude], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(currentMap);
    L.marker([p.latitude,p.longitude]).addTo(currentMap)
      .bindPopup(p.name).openPopup();
  },50);
}

// —Å—Ç–∞—Ä—Ç
loadCategories();
</script>
</body>
</html>
